# Create a function that downloads files from urls
function Get-ListFromUrl ($url) {
  Write-Host "Downloading hash list from $url..."
  try {
	# Download the zip file
	Write-Host "     Downloading ZIP file"
    $zipFilePath = "$PWD\hashlist.zip"
    Invoke-WebRequest -Uri $url -OutFile $zipFilePath
    # Extract the contents of the zip file
	Write-Host "     Extracting ZIP file"
    $extractedFolderPath = "$PWD\hashlist"
    Expand-Archive -Path $zipFilePath -DestinationPath $extractedFolderPath -Force
	# Get the path to the extracted text file
    $textFilePath = Get-ChildItem -Path $extractedFolderPath -Filter "*.txt" | Select-Object -ExpandProperty FullName
    # Read the contents of the text file
    $list = Get-Content -Path $textFilePath
    Write-Host "     Filtering out comments and other lines we don't want"
	$list = $list -split '\r?\n' | Where-Object { $_ -match '\S' -and $_ -notmatch '^\s*#|^//.*' }
    return $list
  }
  catch {
    Write-Host "Error downloading ${url}: $_. Skipping."
    return $null
  }
}

Write-Host "Splitting the hash into files with no more than 130,000 entries"

# Import the necessary modules.
Import-Module BitsTransfer

# Get the list of domains.
$domains = Get-ListFromUrl ('https://bazaar.abuse.ch/export/txt/sha256/full/') | Sort-Object -Unique

# Get the number of domains in the list.
$numDomains = $domains.Count

# Calculate the number of pages.
$numPages = [math]::Ceiling($numDomains / 130000)

# Create an array to store the pages.
$pages = @()

Write-Host "Splitting the file into $numPages pages"
# Loop through the pages.
for ($i = 0; $i -lt $numPages; $i++) {

    # Get the start and end index of the current page.
    $start = $i * 130000
    $end = ($i + 1) * 130000

    # Get the domains for the current page.
    $pageDomains = $domains[$start..$end]

	$i += 1
	Write-Host "Writing page $i of $numPages"
    # Write the header to the current page.
Out-File -FilePath "C:\IT_Tools\hashes\Fort-Hole_malware_bazaar_hashfiles_$i.txt" -InputObject @"
################################################################
# MalwareBazaar full malware samples dump (MD5 hashes)         #
# Last updated: Updated: $(Get-Date -Format "yyyyMMddHHmm")    #
# Total Hashes: $numDomains                                    #
#                                                              #
# Terms Of Use: https://bazaar.abuse.ch/faq/#tos               #
# For questions please contact bazaar [at] abuse.ch            #
################################################################
#### 
# =========================================================================================
# This list has been modified from the original. It has been formatted for use with FortiOS.
# =========================================================================================
# Page $i of $([math]::Ceiling($numPages))

"@ -Encoding UTF8

    # Write the current page to a file.
    Out-File -FilePath "C:\IT_Tools\hashes\Fort-Hole_malware_bazaar_hashfiles_$i.txt" -InputObject $pageDomains -Append -Encoding UTF8
	$i -= 1
}
Write-Host "Finished writing a total of $numPages pages."